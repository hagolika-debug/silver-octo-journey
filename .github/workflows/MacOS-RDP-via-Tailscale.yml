name: macOS RDP via Tailscale

on:
  workflow_dispatch:
    inputs:
      test_mode:
        description: "Run 5-minute test loop"
        type: boolean
        default: false
      runtime_minutes:
        description: "Runtime in minutes (max 360; capped to 355)"
        required: false
        default: "355"
      loops:
        description: "How many handoffs (0 = infinite)"
        required: false
        default: "0"

concurrency:
  group: tailscale-rdp-macos-singleton
  cancel-in-progress: false

permissions:
  contents: read
  actions: write

defaults:
  run:
    shell: bash

env:
  # --- Fixed credentials/identifiers (EDIT THESE) ---
  TS_TAILNET: "wadide55@gmail.com"
  TS_APIKEY: "tskey-api-kF626rt9vQ11CNTRL-ARaUbRDQRK1EEvUJJJtyK1wivDmSfPLEQ"
  TS_AUTHKEY: "tskey-auth-kg1JajUh5H11CNTRL-i9kZ8H35AdeWUTScYtKhdeq3vpwPrgfsb"
  # --- RDP/VNC account & host ---
  RDP_USER: rdpuser
  RDP_PASS: rdprdp@12345
  TS_HOSTNAME: rdp-macos

jobs:
  rdp:
    runs-on: macos-latest
    timeout-minutes: 370
    steps:
      - name: 🔧 Resolve inputs
        id: cfg
        run: |
          # Parse test mode
          if [[ "${{ inputs.test_mode }}" == "true" ]]; then
            IS_TEST=true
            RUNTIME=5
          else
            IS_TEST=false
            RUNTIME=${{ inputs.runtime_minutes }}
            # Validate runtime is a number
            if ! [[ "$RUNTIME" =~ ^[0-9]+$ ]]; then
              RUNTIME=355
            fi
            # Ensure minimum runtime when not in test mode
            if [[ $RUNTIME -lt 6 ]]; then
              RUNTIME=355
            fi
            # Cap at 355 if too high
            if [[ $RUNTIME -gt 360 ]]; then
              RUNTIME=355
            fi
          fi

          # Parse loops
          LOOPS=${{ inputs.loops }}
          if ! [[ "$LOOPS" =~ ^[0-9]+$ ]]; then
            LOOPS=0
          fi
          if [[ $LOOPS -lt 0 ]]; then
            LOOPS=0
          fi

          echo "tailnet=${{ env.TS_TAILNET }}" >> $GITHUB_OUTPUT
          echo "apikey=${{ env.TS_APIKEY }}" >> $GITHUB_OUTPUT
          echo "authkey=${{ env.TS_AUTHKEY }}" >> $GITHUB_OUTPUT
          echo "runtime=$RUNTIME" >> $GITHUB_OUTPUT
          echo "loops=$LOOPS" >> $GITHUB_OUTPUT
          echo "Resolved: test=$IS_TEST, runtime=$RUNTIME, loops=$LOOPS"

      - name: ⚙️ Install Tailscale (open source)
        run: |
          # Install Tailscale using Homebrew (open source method)
          brew install tailscale
          
          # Start tailscaled daemon in background
          sudo tailscaled install-system-daemon
          
          # Wait for daemon to be ready
          sleep 3
          
          echo "Tailscale daemon started"

      - name: 🔐 Setup VNC Server with Virtual Display
        run: |
          # Create user account first
          sudo dscl . -create /Users/${{ env.RDP_USER }}
          sudo dscl . -create /Users/${{ env.RDP_USER }} UserShell /bin/bash
          sudo dscl . -create /Users/${{ env.RDP_USER }} RealName "RDP User"
          sudo dscl . -create /Users/${{ env.RDP_USER }} UniqueID 1001
          sudo dscl . -create /Users/${{ env.RDP_USER }} PrimaryGroupID 80
          sudo dscl . -create /Users/${{ env.RDP_USER }} NFSHomeDirectory /Users/${{ env.RDP_USER }}
          sudo dscl . -passwd /Users/${{ env.RDP_USER }} "${{ env.RDP_PASS }}"
          
          # Create home directory
          sudo createhomedir -c -u ${{ env.RDP_USER }} || true
          
          # Add to admin group
          sudo dscl . -append /Groups/admin GroupMembership ${{ env.RDP_USER }}
          
          # Install TigerVNC server (supports virtual displays)
          brew install tiger-vnc
          
          # Find where TigerVNC was installed
          VNC_PREFIX=$(brew --prefix tiger-vnc)
          echo "TigerVNC installed at: $VNC_PREFIX"
          
          # List files to find binaries
          ls -la "$VNC_PREFIX/bin/" || echo "No bin directory"
          ls -la "$VNC_PREFIX/" || echo "Prefix directory listing failed"
          
          # Try to find vncserver and vncpasswd
          VNCSERVER=$(find "$VNC_PREFIX" -name "vncserver" -type f 2>/dev/null | head -1)
          VNCPASSWD=$(find "$VNC_PREFIX" -name "vncpasswd" -type f 2>/dev/null | head -1)
          
          echo "Found vncserver: $VNCSERVER"
          echo "Found vncpasswd: $VNCPASSWD"
          
          if [[ -z "$VNCSERVER" ]] || [[ -z "$VNCPASSWD" ]]; then
            echo "Error: TigerVNC binaries not found"
            echo "Trying alternative: using built-in Screen Sharing instead"
            
            # Fallback to macOS Screen Sharing
            sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
              -activate -configure -access -on \
              -configure -allowAccessFor -allUsers \
              -configure -restart -agent -privs -all
            
            echo "Using macOS Screen Sharing on port 5900"
            echo "Note: You may see a black screen - this is a limitation of headless macOS runners"
            exit 0
          fi
          
          # Create VNC password file
          mkdir -p ~/.vnc
          echo "${{ env.RDP_PASS }}" | "$VNCPASSWD" -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd
          
          # Start VNC server with virtual display
          "$VNCSERVER" :1 -geometry 1920x1080 -depth 24 -localhost no -SecurityTypes VncAuth -PasswordFile ~/.vnc/passwd &
          
          # Wait for VNC server to start
          sleep 5
          
          # Check if VNC is running
          if pgrep -f "Xvnc" > /dev/null; then
            echo "VNC server started successfully on display :1 (port 5901)"
            echo "VNC server running on port 5901"
          else
            echo "Warning: VNC server may not have started properly"
            cat ~/.vnc/*.log 2>/dev/null || echo "No VNC logs found"
          fi
          
          echo "Connect using: <tailscale-ip>:5901"

      - name: 🧹 PURGE any devices containing hostname (startup)
        run: |
          HOSTNAME="${{ env.TS_HOSTNAME }}"
          echo "Looking for devices matching: $HOSTNAME"
          DEVICES=$(curl -s -H "Authorization: Bearer ${{ steps.cfg.outputs.apikey }}" \
            "https://api.tailscale.com/api/v2/tailnet/$(echo '${{ steps.cfg.outputs.tailnet }}' | jq -sRr @uri)/devices")
          
          if [[ -n "$DEVICES" ]] && echo "$DEVICES" | jq -e '.devices' > /dev/null 2>&1; then
            # Match hostname with optional suffix (e.g., rdp-macos, rdp-macos-1, rdp-macos-2)
            echo "$DEVICES" | jq -r --arg hostname "$HOSTNAME" '.devices[]? | select((.name | test("^" + $hostname + "(-[0-9]+)?$"; "i")) or (.hostname | test("^" + $hostname + "(-[0-9]+)?$"; "i"))) | "\(.id) - \(.name // .hostname)"' | while read -r device_info; do
              device_id=$(echo "$device_info" | cut -d' ' -f1)
              device_name=$(echo "$device_info" | cut -d'-' -f2-)
              if [[ -n "$device_id" ]]; then
                echo "Deleting device: $device_name (ID: $device_id)"
                curl -s -X DELETE -H "Authorization: Bearer ${{ steps.cfg.outputs.apikey }}" \
                  "https://api.tailscale.com/api/v2/device/$device_id" || true
              fi
            done
          else
            echo "No devices found or API error - skipping purge"
          fi

      - name: 🔗 Tailscale up + show IP/FQDN
        id: up
        run: |
          # Connect to Tailscale using CLI
          sudo tailscale up \
            --authkey "${{ steps.cfg.outputs.authkey }}" \
            --hostname "${{ env.TS_HOSTNAME }}" \
            --accept-routes \
            --accept-dns=false
          
          sleep 3
          
          # Get Tailscale IP
          IP4=$(tailscale ip -4)
          STATUS=$(tailscale status --json)
          FQDN=$(echo "$STATUS" | jq -r '.Self.DNSName')
          DERP=$(echo "$STATUS" | jq -r '.Self.Relay')
          
          echo "ip4=$IP4" >> $GITHUB_OUTPUT
          echo "fqdn=$FQDN" >> $GITHUB_OUTPUT
          echo "derp=$DERP" >> $GITHUB_OUTPUT
          
          {
            echo "### VNC (macOS)"
            echo "Host: ${{ env.TS_HOSTNAME }}"
            echo "IPv4: $IP4"
            echo "MagicDNS: $FQDN"
            echo "DERP: $DERP"
            echo "Password: ${{ env.RDP_PASS }}"
            echo ""
            echo "**VNC Port:** 5901 (display :1)"
            echo "**Resolution:** 1920x1080"
            echo ""
            echo "**Connect using:**"
            echo "- VNC Viewer: \`$IP4:5901\`"
            echo "- macOS Screen Sharing: \`vnc://$IP4:5901\`"
            echo "- Or use MagicDNS: \`vnc://$FQDN:5901\`"
            echo ""
            echo "**Note:** Use password \`${{ env.RDP_PASS }}\` when prompted"
          } >> $GITHUB_STEP_SUMMARY

      - name: ⏳ Keep alive
        run: |
          RUNTIME=${{ steps.cfg.outputs.runtime }}
          END_TIME=$(($(date +%s) + RUNTIME * 60))
          
          while [[ $(date +%s) -lt $END_TIME ]]; do
            LEFT=$(( (END_TIME - $(date +%s)) / 60 ))
            echo "Screen Sharing alive... ($LEFT min left)"
            sleep 60
          done

      - name: 🧹 PURGE any devices containing hostname (exit)
        if: always()
        run: |
          HOSTNAME="${{ env.TS_HOSTNAME }}"
          echo "Looking for devices matching: $HOSTNAME"
          DEVICES=$(curl -s -H "Authorization: Bearer ${{ steps.cfg.outputs.apikey }}" \
            "https://api.tailscale.com/api/v2/tailnet/$(echo '${{ steps.cfg.outputs.tailnet }}' | jq -sRr @uri)/devices")
          
          if [[ -n "$DEVICES" ]] && echo "$DEVICES" | jq -e '.devices' > /dev/null 2>&1; then
            # Match hostname with optional suffix (e.g., rdp-macos, rdp-macos-1, rdp-macos-2)
            echo "$DEVICES" | jq -r --arg hostname "$HOSTNAME" '.devices[]? | select((.name | test("^" + $hostname + "(-[0-9]+)?$"; "i")) or (.hostname | test("^" + $hostname + "(-[0-9]+)?$"; "i"))) | "\(.id) - \(.name // .hostname)"' | while read -r device_info; do
              device_id=$(echo "$device_info" | cut -d' ' -f1)
              device_name=$(echo "$device_info" | cut -d'-' -f2-)
              if [[ -n "$device_id" ]]; then
                echo "Deleting device: $device_name (ID: $device_id)"
                curl -s -X DELETE -H "Authorization: Bearer ${{ steps.cfg.outputs.apikey }}" \
                  "https://api.tailscale.com/api/v2/device/$device_id" || true
              fi
            done
          else
            echo "No devices found or API error - skipping purge"
          fi

      - name: 🔁 Restart workflow (self-dispatch)
        if: always()
        run: |
          LOOPS=${{ steps.cfg.outputs.loops }}
          
          if [[ $LOOPS -eq 1 ]]; then
            echo "Loops finished; not dispatching."
            exit 0
          fi
          
          if [[ $LOOPS -gt 1 ]]; then
            NEXT=$((LOOPS - 1))
          else
            NEXT=0
          fi
          
          curl -X POST \
            -H "Authorization: Bearer ${{ github.token }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/MacOS-RDP-via-Tailscale.yml/dispatches" \
            -d "{\"ref\":\"${{ github.ref_name }}\",\"inputs\":{\"test_mode\":\"false\",\"runtime_minutes\":\"${{ steps.cfg.outputs.runtime }}\",\"loops\":\"$NEXT\"}}"
